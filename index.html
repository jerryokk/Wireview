<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="https://wireview.github.io/wireshark.svg" />
  <title>Wireview - File Analyzer</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .logo {
      display: block;
      width: 100px;
      margin: 0 auto 20px auto;
    }
    .status {
      text-align: center;
      padding: 10px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.loading {
      background: #e2f3fb;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      background: #fafbfc;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 10px;
    }
    .file-input {
      display: none;
    }
    .file-label {
      background: #6c757d;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: background 0.3s;
      display: inline-block;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .file-label:hover {
      background: #545b62;
    }
    .file-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      display: none;
    }
    .file-info.show {
      display: block;
    }
    .file-info h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    .file-info p {
      margin: 5px 0;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
      width: 100%;
      margin-top: 15px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message-log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .message-item {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #007bff;
      background: white;
    }
    .message-item.info {
      border-left-color: #17a2b8;
    }
    .message-item.error {
      border-left-color: #dc3545;
    }
    .message-item.success {
      border-left-color: #28a745;
    }
    .timestamp {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 12px;
    }
    .footer a {
      color: #007bff;
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://wireview.github.io/wireshark.svg" alt="Wireview Logo" class="logo">
    <h1>Wireview - æ•è·æ–‡ä»¶åˆ†æå™¨</h1>
    
    <div id="status" class="status loading">
      åŠ è½½ä¸­...è¯·ç¨å€™
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">ğŸ“ é€‰æ‹©æ–‡ä»¶</h3>
      </div>
      <div class="input-group">
        <label>é€‰æ‹©è¦åˆ†æçš„ pcap/pcapng æ•è·æ–‡ä»¶:</label>
        <label for="fileInput" class="file-label" id="fileInputLabel">ğŸ“ é€‰æ‹©æ•è·æ–‡ä»¶</label>
        <input type="file" id="fileInput" class="file-input" accept=".cap,.pcap,.pcapng,application/vnd.tcpdump.pcap">
        
        <div id="fileInfo" class="file-info">
          <h4>ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h4>
          <p><strong>æ–‡ä»¶å:</strong> <span id="fileName">-</span></p>
          <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize">-</span></p>
          <p><strong>æ–‡ä»¶ç±»å‹:</strong> <span id="fileType">-</span></p>
        </div>
        
        <button id="analyzeButton" disabled>ğŸ” åˆ†ææ–‡ä»¶</button>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">ğŸ“‹ æ—¥å¿—</h3>
      </div>
      <div id="messageLog" class="message-log"></div>
    </div>
  </div>
  
  <div class="footer">
    <p>Wireview - åŸºäº Wireshark WebAssembly</p>
    <p>
      <a href="https://github.com/radiantly/Wireview" target="_blank">GitHub</a> |
      <a href="https://www.wireshark.org/" target="_blank">Wireshark</a>
    </p>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let selectedFile = null;
    let popupWindow = null;
    let wasmLoaded = false;
    let wasmCheckCounter = 0;
    
    // å…ƒç´ å¼•ç”¨
    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    const analyzeButton = document.getElementById('analyzeButton');
    const messageLog = document.getElementById('messageLog');
    const statusElement = document.getElementById('status');
    
    // æ—¥å¿—æ¶ˆæ¯å‡½æ•°
    function logMessage(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const messageItem = document.createElement('div');
      messageItem.className = `message-item ${type}`;
      
      messageItem.innerHTML = `
        <div class="timestamp">${timestamp}</div>
        <div class="data">${message}</div>
      `;
      
      messageLog.appendChild(messageItem);
      messageLog.scrollTop = messageLog.scrollHeight;
      
      // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
      console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
    }
    
    // è®¾ç½®çŠ¶æ€æ˜¾ç¤º
    function setStatus(message, type = 'loading') {
      statusElement.textContent = message;
      statusElement.className = `status ${type}`;
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    function displayFileInfo(file) {
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileType.textContent = file.type || 'åº”ç”¨ç¨‹åº/octet-stream';
      fileInfo.classList.add('show');
    }
    
    // éšè—æ–‡ä»¶ä¿¡æ¯
    function hideFileInfo() {
      fileInfo.classList.remove('show');
      fileName.textContent = '-';
      fileSize.textContent = '-';
      fileType.textContent = '-';
    }
    
    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶å¤„ç†
    fileInput.addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      
      if (selectedFile) {
        displayFileInfo(selectedFile);
        logMessage(`å·²é€‰æ‹©æ–‡ä»¶: ${selectedFile.name} (${formatFileSize(selectedFile.size)})`, 'info');
        analyzeButton.disabled = false;
      } else {
        hideFileInfo();
        analyzeButton.disabled = true;
      }
    });
    
    // æ£€æŸ¥å¼¹å‡ºçª—å£çš„ WASM æ˜¯å¦å·²åŠ è½½
    function checkWasmLoaded() {
      wasmCheckCounter++;
      
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæ£€æŸ¥60ç§’
      if (wasmCheckCounter > 12) {
        setStatus('WASM åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        logMessage('WASM åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }
      
      // å°è¯•è·å– popup çª—å£ä¸­çš„å˜é‡
      try {
        // æ£€æµ‹å¼¹çª—æ˜¯å¦è¿˜å­˜åœ¨
        if (popupWindow && popupWindow.closed) {
          setStatus('å¼¹çª—å·²å…³é—­', 'error');
          logMessage('å¼¹çª—å·²å…³é—­ï¼Œè¯·é‡æ–°å°è¯•', 'error');
          return;
        }
        
        if (popupWindow && popupWindow.manager && popupWindow.manager.initialized) {
          wasmLoaded = true;
          setStatus('WASM å·²åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'success');
          logMessage('WASM å·²åŠ è½½å®Œæˆï¼Œå¯ä»¥å‘é€æ–‡ä»¶', 'success');
          
          // å‘é€æ–‡ä»¶
          sendFileToPopup(selectedFile);
        } else {
          logMessage('ç­‰å¾… WASM åŠ è½½...', 'info');
          setTimeout(checkWasmLoaded, 5000);
        }
      } catch (error) {
        logMessage(`æ£€æŸ¥ WASM çŠ¶æ€å‡ºé”™: ${error.message}`, 'error');
        setTimeout(checkWasmLoaded, 5000);
      }
    }
    
    // å‘é€æ–‡ä»¶åˆ°å¼¹çª—
    function sendFileToPopup(file) {
      if (!file || !popupWindow || popupWindow.closed) {
        logMessage('æ— æ³•å‘é€æ–‡ä»¶: æ–‡ä»¶æœªé€‰æ‹©æˆ–å¼¹çª—å·²å…³é—­', 'error');
        return;
      }
      
      logMessage(`å‡†å¤‡å‘é€æ–‡ä»¶åˆ°å¼¹çª—: ${file.name}`, 'info');
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          // å‘é€æ–‡ä»¶æ•°æ®åˆ°å¼¹çª—
          popupWindow.postMessage({
            type: 'fileData',
            name: file.name,
            fileType: file.type,
            data: e.target.result  // åŒ…å« base64 ç¼–ç çš„æ–‡ä»¶å†…å®¹
          }, '*');
          
          logMessage(`å·²å‘é€æ–‡ä»¶åˆ°å¼¹çª—: ${file.name}`, 'info');
          setStatus('æ–‡ä»¶å·²å‘é€ï¼Œç­‰å¾…åˆ†æç»“æœ', 'loading');
        } catch (error) {
          logMessage(`å‘é€æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
          setStatus('å‘é€æ–‡ä»¶å¤±è´¥', 'error');
        }
      };
      
      reader.onerror = () => {
        logMessage('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
        setStatus('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
      };
      
      // å°†æ–‡ä»¶è¯»å–ä¸º Data URL
      reader.readAsDataURL(file);
    }
    
    // åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
    analyzeButton.addEventListener('click', () => {
      if (!selectedFile) {
        logMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
        return;
      }
      
      setStatus('æ­£åœ¨æ‰“å¼€åˆ†æç•Œé¢...', 'loading');
      logMessage('æ­£åœ¨æ‰“å¼€åˆ†æç•Œé¢...', 'info');
      
      // æ‰“å¼€å¼¹å‡ºçª—å£ï¼Œæ·»åŠ  waiting=true å‚æ•°è¡¨ç¤ºéœ€è¦ç­‰å¾…æ–‡ä»¶ä¼ è¾“
      popupWindow = window.open('./popup.html?waiting=true', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!popupWindow) {
        setStatus('å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸å¼¹çª—', 'error');
        logMessage('å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å…è®¸å¼¹çª—åé‡è¯•', 'error');
        return;
      }
      
      // ç›‘å¬æ¥è‡ªå¼¹çª—çš„æ¶ˆæ¯
      window.addEventListener('message', (event) => {
        // ç¡®ä¿æ¶ˆæ¯æ¥è‡ªæˆ‘ä»¬æ‰“å¼€çš„å¼¹çª—
        if (event.source !== popupWindow) return;
        
        console.log('æ”¶åˆ°æ¥è‡ªå¼¹çª—çš„æ¶ˆæ¯:', event.data);
        
        if (event.data === 'ready') {
          // å¼¹çª—å·²å‡†å¤‡å¥½æ¥æ”¶æ–‡ä»¶ï¼Œæ£€æŸ¥ WASM æ˜¯å¦åŠ è½½å®Œæ¯•
          logMessage('å¼¹çª—å·²å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨ç­‰å¾… WASM åŠ è½½', 'info');
          wasmCheckCounter = 0;
          checkWasmLoaded();
        } else if (event.data.type === 'fileOpened') {
          // æ–‡ä»¶å·²æˆåŠŸåœ¨å¼¹çª—ä¸­æ‰“å¼€
          logMessage(`æ–‡ä»¶å·²åœ¨åˆ†æç•Œé¢ä¸­æˆåŠŸæ‰“å¼€: ${event.data.name}`, 'success');
          setStatus('æ–‡ä»¶å·²æˆåŠŸæ‰“å¼€ï¼Œæ­£åœ¨åˆ†æ', 'success');
        } else if (event.data.type === 'error') {
          // å¼¹çª—æŠ¥å‘Šé”™è¯¯
          logMessage(`å¼¹çª—æŠ¥å‘Šé”™è¯¯: ${event.data.message}`, 'error');
          setStatus('æ–‡ä»¶åˆ†æå‡ºé”™', 'error');
        }
      });
    });
    
    // é¡µé¢åŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', () => {
      setStatus('å‡†å¤‡å°±ç»ªï¼Œè¯·é€‰æ‹©æ–‡ä»¶', 'success');
      logMessage('åº”ç”¨å·²åŠ è½½ï¼Œè¯·é€‰æ‹©è¦åˆ†æçš„æ•è·æ–‡ä»¶', 'info');
    });
  </script>
</body>
</html>